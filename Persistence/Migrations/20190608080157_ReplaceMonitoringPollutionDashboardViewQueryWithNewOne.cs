using Microsoft.EntityFrameworkCore.Migrations;

namespace Persistence.Migrations
{
    public partial class ReplaceMonitoringPollutionDashboardViewQueryWithNewOne : Migration
    {
        protected override void Up(MigrationBuilder migrationBuilder)
        {
            var deleteOld = @"DROP VIEW IF EXISTS `v_monitoringpollutiondashboard`;";
            migrationBuilder.Sql(deleteOld);
            var cmd = @"CREATE VIEW v_monitoringpollutiondashboard AS 
            select `q1`.`Province` AS `Province`,`q1`.`MonitoringYear` AS `MonitoringYear`,`q1`.`PeriodTitle` AS `PeriodTitle`,`q1`.`PeriodId` AS `PeriodId`,`q1`.`AmbientAirPollution` AS `AmbientAirPollution`,`q1`.`ChimneyPollution` AS `ChimneyPollution`,`q1`.`WastePollution` AS `WastePollution`,`q1`.`WastewaterPollution` AS `WastewaterPollution`,`q1`.`SoundAndWavesPollution` AS `SoundAndWavesPollution`,`q1`.`AmbientAirPollution` + `q1`.`ChimneyPollution` + `q1`.`WastePollution` + `q1`.`WastewaterPollution` + `q1`.`SoundAndWavesPollution` AS `TotalPollution` from (select `ostanenums`.`Title` AS `Province`,`iusr`.`MonitoringYear` AS `MonitoringYear`,`monitoringperiods`.`Title` AS `PeriodTitle`,`monitoringperiods`.`Id` AS `PeriodId`,coalesce((select count(distinct `doe`.`industrialunitssamplingresults`.`Id`) from (((`doe`.`industrialunitssamplingresults` join `doe`.`parameterssamplingresults` `psr` on(`doe`.`industrialunitssamplingresults`.`Id` = `psr`.`IndustrialUnitsSamplingResultId`)) join `doe`.`monitoringparameters` `mp` on(`mp`.`Id` = `psr`.`MonitoringParametersId`)) join `doe`.`ambientairparametersresults` `amb` on(`amb`.`ParametersSamplingResultsId` = `psr`.`Id`)) where `doe`.`industrialunitssamplingresults`.`Id` = `iusr`.`Id` and `doe`.`industrialunitssamplingresults`.`FinalSave` = 1 and `amb`.`Quantity` > `mp`.`PollutionLimitQuantity`),0) AS `AmbientAirPollution`,coalesce((select count(distinct `doe`.`industrialunitssamplingresults`.`Id`) from (((`doe`.`industrialunitssamplingresults` join `doe`.`parameterssamplingresults` `psr` on(`doe`.`industrialunitssamplingresults`.`Id` = `psr`.`IndustrialUnitsSamplingResultId`)) join `doe`.`monitoringparameters` `mp` on(`mp`.`Id` = `psr`.`MonitoringParametersId`)) join `doe`.`chimneyparametersresults` `chm` on(`chm`.`ParametersSamplingResultsId` = `psr`.`Id`)) where `doe`.`industrialunitssamplingresults`.`Id` = `iusr`.`Id` and `doe`.`industrialunitssamplingresults`.`FinalSave` = 1 and `chm`.`Quantity` > `mp`.`PollutionLimitQuantity`),0) AS `ChimneyPollution`,coalesce((select count(distinct `doe`.`industrialunitssamplingresults`.`Id`) from (((`doe`.`industrialunitssamplingresults` join `doe`.`parameterssamplingresults` `psr` on(`doe`.`industrialunitssamplingresults`.`Id` = `psr`.`IndustrialUnitsSamplingResultId`)) join `doe`.`monitoringparameters` `mp` on(`mp`.`Id` = `psr`.`MonitoringParametersId`)) join `doe`.`wasteparametersresults` `waste` on(`waste`.`ParametersSamplingResultsId` = `psr`.`Id`)) where `doe`.`industrialunitssamplingresults`.`Id` = `iusr`.`Id` and `doe`.`industrialunitssamplingresults`.`FinalSave` = 1 and `waste`.`Quantity` > `mp`.`PollutionLimitQuantity`),0) AS `WastePollution`,coalesce((select count(distinct `doe`.`industrialunitssamplingresults`.`Id`) from (((`doe`.`industrialunitssamplingresults` join `doe`.`parameterssamplingresults` `psr` on(`doe`.`industrialunitssamplingresults`.`Id` = `psr`.`IndustrialUnitsSamplingResultId`)) join `doe`.`monitoringparameters` `mp` on(`mp`.`Id` = `psr`.`MonitoringParametersId`)) join `doe`.`wastewaterparametersresults` `ww` on(`ww`.`ParametersSamplingResultsId` = `psr`.`Id`)) where `doe`.`industrialunitssamplingresults`.`Id` = `iusr`.`Id` and `doe`.`industrialunitssamplingresults`.`FinalSave` = 1 and `ww`.`Quantity` > `mp`.`PollutionLimitQuantity`),0) AS `WastewaterPollution`,coalesce((select count(distinct `doe`.`industrialunitssamplingresults`.`Id`) from (((`doe`.`industrialunitssamplingresults` join `doe`.`parameterssamplingresults` `psr` on(`doe`.`industrialunitssamplingresults`.`Id` = `psr`.`IndustrialUnitsSamplingResultId`)) join `doe`.`monitoringparameters` `mp` on(`mp`.`Id` = `psr`.`MonitoringParametersId`)) join `doe`.`soundandwavesparametersresults` `sw` on(`sw`.`ParametersSamplingResultsId` = `psr`.`Id`)) where `doe`.`industrialunitssamplingresults`.`Id` = `iusr`.`Id` and `doe`.`industrialunitssamplingresults`.`FinalSave` = 1 and `sw`.`Quantity` > `mp`.`PollutionLimitQuantity`),0) AS `SoundAndWavesPollution` from (((((`doe`.`industrialunitssamplingresults` `iusr` join `doe`.`industry_workshopaddresses` `iwa` on(`iwa`.`IndustryId` = `iusr`.`IndustryId`)) join `doe`.`enumdata` `ostanenums` on(`ostanenums`.`Id` = `iwa`.`ProvinceId`)) join `doe`.`enumdata` `monitoringperiods` on(`iusr`.`MonitoringPeriodId` = `monitoringperiods`.`Id`)) join `doe`.`parameterssamplingresults` `psr` on(`iusr`.`Id` = `psr`.`IndustrialUnitsSamplingResultId`)) join `doe`.`monitoringparameters` `mp` on(`mp`.`Id` = `psr`.`MonitoringParametersId`)) where `iusr`.`FinalSave` = 1 group by `ostanenums`.`Title`,`iusr`.`MonitoringYear`,`iusr`.`MonitoringPeriodId`) `q1`";
            migrationBuilder.Sql(cmd);
        }

        protected override void Down(MigrationBuilder migrationBuilder)
        {
            var cmd = @"DROP VIEW IF EXISTS `v_monitoringpollutiondashboard`;";
            migrationBuilder.Sql(cmd);
        }
    }
}
